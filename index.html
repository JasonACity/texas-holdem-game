<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¾·å·æ‰‘å…‹ - Texas Hold'em</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%); min-height: 100vh; color: #fff; overflow: hidden; touch-action: manipulation; }
        .setup-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%); z-index: 1000; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        .setup-screen h1 { text-align: center; color: #ffd700; margin-bottom: 30px; font-size: 1.8rem; text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3); }
        .setup-group { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .setup-group h3 { color: #ffd700; font-size: 1rem; margin-bottom: 12px; }
        .setup-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .setup-item { flex: 1; }
        .setup-item label { display: block; font-size: 0.8rem; color: #aaa; margin-bottom: 5px; }
        .setup-item input, .setup-item select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: #fff; font-size: 1rem; }
        .ai-config-list { display: flex; flex-direction: column; gap: 8px; }
        .ai-config-item { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.2); padding: 10px 12px; border-radius: 8px; }
        .btn { padding: 15px 30px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; text-align: center; }
        .btn-primary { background: linear-gradient(135deg, #e94560, #c73e54); color: #fff; width: 100%; margin-top: 20px; }
        .game-table { display: none; flex-direction: column; height: 100vh; position: relative; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: rgba(0,0,0,0.5); }
        .pot-amount { font-size: 1.3rem; color: #ffd700; font-weight: bold; }
        .stage-badge { background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 15px; font-size: 0.75rem; }
        .opponents-area { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; padding: 10px 0; }
        .opponent-seat { background: rgba(0,0,0,0.6); border-radius: 12px; padding: 8px 10px; min-width: 70px; text-align: center; border: 2px solid transparent; }
        .opponent-seat.active { border-color: #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }
        .opponent-seat.folded { opacity: 0.4; }
        .opponent-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; margin: 0 auto 5px; font-weight: bold; }
        .opponent-name { font-size: 0.7rem; margin-bottom: 2px; }
        .opponent-type { font-size: 0.6rem; color: #aaa; margin-bottom: 3px; }
        .opponent-chips { font-size: 0.75rem; color: #ffd700; }
        .opponent-bet { font-size: 0.65rem; color: #e94560; margin-top: 2px; }
        .opponent-cards { display: flex; gap: 3px; justify-content: center; margin-top: 5px; }
        .opponent-cards .card { width: 28px; height: 40px; font-size: 0.7rem; }
        .community-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(ellipse at center, #2d5a3d 0%, #1a3d2a 70%, #0d2920 100%); border-radius: 50%; margin: 10px 20px; border: 3px solid #3d2817; box-shadow: inset 0 0 50px rgba(0,0,0,0.5); }
        .community-cards { display: flex; gap: 6px; justify-content: center; flex-wrap: wrap; }
        .player-area { background: rgba(0,0,0,0.7); border-radius: 20px 20px 0 0; padding: 15px; border-top: 2px solid rgba(255,215,0,0.3); }
        .player-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .player-details h3 { font-size: 1rem; margin-bottom: 3px; display: flex; align-items: center; }
        .player-chips { color: #ffd700; font-size: 1.1rem; font-weight: bold; }
        .position-badge { background: linear-gradient(135deg, #667eea, #764ba2); padding: 4px 10px; border-radius: 12px; font-size: 0.7rem; margin-left: 8px; }
        .hand-strength { background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.3); padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; text-align: center; }
        .hand-strength .win-rate { font-size: 1.1rem; font-weight: bold; color: #ffd700; }
        .player-cards { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; }
        .card { width: 60px; height: 84px; background: #fff; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 3px 15px rgba(0,0,0,0.4); border: 1px solid #ddd; font-size: 1.2rem; }
        .card.red { color: #e94560; }
        .card.black { color: #333; }
        .card-back { background: linear-gradient(135deg, #1a237e, #0d1642); border: 2px solid #ffd700; }
        .card-back::after { content: "â™ "; font-size: 2rem; color: rgba(255,215,0,0.3); }
        .action-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .action-btn { padding: 15px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; color: #fff; cursor: pointer; }
        .btn-fold { background: #666; }
        .btn-check { background: #4a90d9; }
        .btn-call { background: #f5a623; }
        .btn-raise { background: #e94560; grid-column: span 2; }
        .btn-allin { background: #9013fe; }
        .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); padding: 20px 30px; border-radius: 10px; font-size: 1.1rem; z-index: 1001; display: none; }
        .winner { border-color: #ffd700 !important; background: rgba(255,215,0,0.2) !important; }
        .version { position: fixed; bottom: 5px; right: 10px; font-size: 0.7rem; color: rgba(255,255,255,0.5); z-index: 10000; }
    </style>
</head>
<body>
    <div class="setup-screen" id="setupScreen">
        <h1>ğŸƒ å¾·å·æ‰‘å…‹</h1>
        <div class="setup-group">
            <h3>ğŸ’° æ¸¸æˆè®¾ç½®</h3>
            <div class="setup-row">
                <div class="setup-item">
                    <label>åˆå§‹ç­¹ç </label>
                    <input type="number" id="startingChips" value="1000" min="100" step="100">
                </div>
                <div class="setup-item">
                    <label>å°ç›²/å¤§ç›²</label>
                    <input type="text" id="blinds" value="10/20">
                </div>
            </div>
        </div>
        <div class="setup-group">
            <h3>ğŸ¤– AIç©å®¶è®¾ç½®</h3>
            <div class="setup-row">
                <div class="setup-item">
                    <label>AIæ•°é‡</label>
                    <select id="aiCount" onchange="updateAIList()">
                        <option value="3">3äºº</option>
                        <option value="4" selected>4äºº</option>
                        <option value="5">5äºº</option>
                    </select>
                </div>
            </div>
            <div class="ai-config-list" id="aiConfigList"></div>
        </div>
        <button class="btn btn-primary" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
    </div>
    
    <div class="game-table" id="gameTable">
        <div class="top-bar">
            <div>åº•æ± : <span class="pot-amount" id="potAmount">$0</span></div>
            <div class="stage-badge" id="stageBadge">ç­‰å¾…å¼€å§‹</div>
        </div>
        
        <div class="opponents-area" id="opponentsArea"></div>
        
        <div class="community-area">
            <div class="community-cards" id="communityCards"></div>
        </div>
        
        <div class="player-area">
            <div class="player-info">
                <div class="player-details">
                    <h3>ä½  <span class="position-badge" id="playerPosition">BTN</span></h3>
                    <div class="player-chips" id="playerChips">$1000</div>
                </div>
                <div class="hand-strength">
                    <div id="handRank">-</div>
                    <div class="win-rate" id="winRate"></div>
                </div>
            </div>
            <div class="player-cards" id="playerCards"></div>
            <div class="action-buttons" id="actionButtons" style="display: none;">
                <button class="action-btn btn-fold" onclick="playerAction('fold')">å¼ƒç‰Œ</button>
                <button class="action-btn btn-check" id="btnCheck" onclick="playerAction('check')">è¿‡ç‰Œ</button>
                <button class="action-btn btn-call" id="btnCall" onclick="playerAction('call')">è·Ÿæ³¨</button>
                <button class="action-btn btn-raise" onclick="playerAction('raise')">åŠ æ³¨</button>
                <button class="action-btn btn-allin" onclick="playerAction('allin')">å…¨ä¸‹</button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    <div class="version">Texas Hold'em v1.0.8</div>

    <script>
        // ç‰ˆæœ¬å·
        const VERSION = 'v1.0.8';
        console.log('Texas Hold\'em Game ' + VERSION);
        
        // æ¸¸æˆå¸¸é‡
        const SUITS = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
        const RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', 'T', 'J', 'Q', 'K', 'A'];
        
        const AI_TYPES = {
            TAG: { name: 'ç´§å‡¶', color: '#4CAF50', vpip: 0.18, pfr: 0.15, aggression: 2.5 },
            LAG: { name: 'æ¾å‡¶', color: '#f44336', vpip: 0.35, pfr: 0.28, aggression: 3.0 },
            TP: { name: 'ç´§å¼±', color: '#2196F3', vpip: 0.12, pfr: 0.06, aggression: 1.2 },
            LP: { name: 'æ¾å¼±', color: '#FF9800', vpip: 0.40, pfr: 0.08, aggression: 0.8 }
        };
        
        // æ¸¸æˆçŠ¶æ€
        let game = {
            players: [], deck: [], communityCards: [], pot: 0, currentBet: 0,
            stage: 'preflop', activeIndex: 0, dealerIndex: 0, sb: 10, bb: 20,
            lastRaiserIndex: -1  // è·Ÿè¸ªæœ€ååŠ æ³¨è€…ï¼Œç”¨äºåˆ¤æ–­ä¸‹æ³¨è½®æ¬¡æ˜¯å¦ç»“æŸ
        };
        
        let lastHandCards = '';
        
        // åˆå§‹åŒ–
        function updateAIList() {
            var count = parseInt(document.getElementById('aiCount').value) || 4;
            var container = document.getElementById('aiConfigList');
            container.innerHTML = '';
            for (var i = 0; i < count; i++) {
                var div = document.createElement('div');
                div.className = 'ai-config-item';
                div.innerHTML = '<span>AI ' + (i + 1) + '</span><select id="aiType' + i + '"' + 
                    '><option value="TAG">ç´§å‡¶å‹</option><option value="LAG" selected>æ¾å‡¶å‹</option>' +
                    '<option value="TP">ç´§å¼±å‹</option><option value="LP">æ¾å¼±å‹</option></select>';
                container.appendChild(div);
            }
        }
        
        updateAIList();
        
        // åˆ›å»ºç‰Œç»„
        function createDeck() {
            var deck = [];
            for (var s = 0; s < SUITS.length; s++) {
                for (var r = 0; r < RANKS.length; r++) {
                    deck.push({ suit: SUITS[s], rank: RANKS[r], value: r });
                }
            }
            // æ´—ç‰Œ
            for (var i = deck.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = deck[i];
                deck[i] = deck[j];
                deck[j] = temp;
            }
            return deck;
        }
        
        function deal() { return game.deck.pop(); }
        
        function placeBet(player, amount) {
            var actual = Math.min(amount, player.chips);
            player.chips -= actual;
            player.bet += actual;
            game.pot += actual;
            if (player.chips === 0) player.allIn = true;
        }
        
        function getPositionName(index) {
            var pos = (index - game.dealerIndex + game.players.length) % game.players.length;
            var names = ['BTN', 'SB', 'BB', 'UTG', 'MP', 'CO'];
            return names[pos] || 'MP';
        }
        
        function calculateWinRate(hole, community) {
            if (hole.length !== 2) return 0;
            var all = hole.concat(community);
            var ranks = all.map(function(c) { return c.value; });
            var suits = all.map(function(c) { return c.suit; });
            
            var winRate = 0;
            var rankCounts = {};
            ranks.forEach(function(r) { rankCounts[r] = (rankCounts[r] || 0) + 1; });
            var maxCount = 0;
            for (var k in rankCounts) { if (rankCounts[k] > maxCount) maxCount = rankCounts[k]; }
            
            if (maxCount >= 4) winRate = 95;
            else if (maxCount === 3) winRate = 70;
            else if (maxCount === 2) winRate = 45;
            else winRate = Math.max(hole[0].value, hole[1].value) / 12 * 35;
            
            var suitCounts = {};
            suits.forEach(function(s) { suitCounts[s] = (suitCounts[s] || 0) + 1; });
            var maxSuit = 0;
            for (var sk in suitCounts) { if (suitCounts[sk] > maxSuit) maxSuit = suitCounts[sk]; }
            if (maxSuit >= 5) winRate += 20;
            else if (maxSuit === 4 && community.length < 5) winRate += 10;
            
            return Math.min(Math.round(winRate), 99);
        }
        
        function evaluateHandRank(hole, community) {
            var all = hole.concat(community);
            if (all.length < 2) return '-';
            
            var ranks = all.map(function(c) { return c.value; });
            var suits = all.map(function(c) { return c.suit; });
            
            // ç»Ÿè®¡ç‚¹æ•°
            var rankCounts = {};
            ranks.forEach(function(r) { rankCounts[r] = (rankCounts[r] || 0) + 1; });
            var counts = Object.values(rankCounts).sort(function(a, b) { return b - a; });
            
            // æ£€æŸ¥åŒèŠ±
            var suitCounts = {};
            suits.forEach(function(s) { suitCounts[s] = (suitCounts[s] || 0) + 1; });
            var hasFlush = false;
            for (var sk in suitCounts) { if (suitCounts[sk] >= 5) hasFlush = true; }
            
            // æ£€æŸ¥é¡ºå­ï¼ˆä¿®å¤ï¼šä½¿ç”¨æ‰€æœ‰ç‰Œçš„ç‚¹æ•°ï¼ŒåŒ…æ‹¬é‡å¤çš„ï¼‰
            var uniqueRanks = [];
            for (var uk in rankCounts) uniqueRanks.push(parseInt(uk));
            uniqueRanks.sort(function(a, b) { return a - b; });
            
            var hasStraight = false;
            // æ£€æŸ¥æ™®é€šé¡ºå­
            for (var i = 0; i <= uniqueRanks.length - 5; i++) {
                if (uniqueRanks[i+4] - uniqueRanks[i] === 4) hasStraight = true;
            }
            // æ£€æŸ¥ A-5 é¡ºå­ (A-2-3-4-5)
            if (uniqueRanks.indexOf(12) !== -1 && uniqueRanks.indexOf(0) !== -1 && 
                uniqueRanks.indexOf(1) !== -1 && uniqueRanks.indexOf(2) !== -1 && 
                uniqueRanks.indexOf(3) !== -1) {
                hasStraight = true;
            }
            
            // åˆ¤æ–­ç‰Œå‹
            if (hasStraight && hasFlush) return 'åŒèŠ±é¡º';
            if (counts[0] >= 4) return 'å››æ¡';
            if (counts[0] === 3 && counts[1] >= 2) return 'è‘«èŠ¦';
            if (hasFlush) return 'åŒèŠ±';
            if (hasStraight) return 'é¡ºå­';
            if (counts[0] === 3) return 'ä¸‰æ¡';
            if (counts[0] === 2 && counts[1] === 2) return 'ä¸¤å¯¹';
            if (counts[0] === 2) return 'ä¸€å¯¹';
            
            return RANKS[Math.max(hole[0].value, hole[1].value)] + 'é«˜ç‰Œ';
        }
        
        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            console.log('startGame called');
            
            var blindsInput = document.getElementById('blinds');
            if (blindsInput) {
                var parts = blindsInput.value.split('/');
                if (parts.length === 2) {
                    game.sb = parseInt(parts[0]) || 10;
                    game.bb = parseInt(parts[1]) || 20;
                }
            }
            
            var startingChips = parseInt(document.getElementById('startingChips').value) || 1000;
            var aiCount = parseInt(document.getElementById('aiCount').value) || 4;
            
            game.players = [{
                id: 0, name: 'ä½ ', isHuman: true,
                chips: startingChips, cards: [], bet: 0, folded: false, allIn: false
            }];
            
            for (var i = 0; i < aiCount; i++) {
                var typeSelect = document.getElementById('aiType' + i);
                var type = typeSelect ? typeSelect.value : 'LAG';
                game.players.push({
                    id: i + 1, name: 'AI' + (i + 1), type: type,
                    isHuman: false, chips: startingChips,
                    cards: [], bet: 0, folded: false, allIn: false
                });
            }
            
            game.dealerIndex = Math.floor(Math.random() * game.players.length);
            
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('gameTable').style.display = 'flex';
            
            newHand();
        }
        
        function newHand() {
            game.deck = createDeck();
            game.communityCards = [];
            game.pot = 0;
            game.currentBet = 0;
            game.stage = 'preflop';
            game.lastRaiserIndex = -1;
            lastHandCards = '';
            
            document.getElementById('communityCards').innerHTML = '';
            
            game.players.forEach(function(p) {
                p.cards = [];
                p.bet = 0;
                p.folded = false;
                p.allIn = false;
            });
            
            for (var i = 0; i < 2; i++) {
                game.players.forEach(function(p) { p.cards.push(deal()); });
            }
            
            var sbIndex = (game.dealerIndex + 1) % game.players.length;
            var bbIndex = (game.dealerIndex + 2) % game.players.length;
            placeBet(game.players[sbIndex], game.sb);
            placeBet(game.players[bbIndex], game.bb);
            game.currentBet = game.bb;
            game.lastRaiserIndex = bbIndex;  // å¤§ç›²è§†ä¸ºæœ€å"åŠ æ³¨"è€…
            actedPlayers.clear();
            actedPlayers.add(sbIndex);
            actedPlayers.add(bbIndex);  // ç›²æ³¨ç©å®¶å·²è¡ŒåŠ¨
            game.activeIndex = (bbIndex + 1) % game.players.length;
            
            showToast('æ–°ä¸€å±€å¼€å§‹');
            updateDisplay();
            nextTurn();
        }
        
        function updateDisplay() {
            document.getElementById('potAmount').textContent = '$' + game.pot;
            var stageNames = { preflop: 'ç¿»ç‰Œå‰', flop: 'ç¿»ç‰Œ', turn: 'è½¬ç‰Œ', river: 'æ²³ç‰Œ', showdown: 'æ‘Šç‰Œ' };
            document.getElementById('stageBadge').textContent = stageNames[game.stage] || game.stage;
            
            var humanIndex = 0;
            for (var i = 0; i < game.players.length; i++) {
                if (game.players[i].isHuman) { humanIndex = i; break; }
            }
            document.getElementById('playerPosition').textContent = getPositionName(humanIndex);
            
            // æ›´æ–°å¯¹æ‰‹
            var opponentsArea = document.getElementById('opponentsArea');
            opponentsArea.innerHTML = '';
            for (var j = 0; j < game.players.length; j++) {
                var p = game.players[j];
                if (p.isHuman) continue;
                var seat = document.createElement('div');
                var isActive = j === game.activeIndex ? 'active' : '';
                var isFolded = p.folded ? 'folded' : '';
                seat.className = 'opponent-seat ' + isActive + ' ' + isFolded;
                var typeInfo = AI_TYPES[p.type] || {};
                var posName = getPositionName(j);
                var betHtml = p.bet > 0 ? '<div class="opponent-bet">$' + p.bet + '</div>' : '';
                seat.innerHTML = '<div class="opponent-avatar" style="background: ' + (typeInfo.color || '#666') + '"' +
                    '>' + posName + '</div><div class="opponent-name">' + p.name + '</div>' +
                    '<div class="opponent-type">' + (typeInfo.name || '') + '</div>' +
                    '<div class="opponent-chips">$' + p.chips + '</div>' + betHtml;
                opponentsArea.appendChild(seat);
            }
            
            // æ›´æ–°å…¬å…±ç‰Œï¼ˆåªæ·»åŠ æ–°ç‰Œï¼‰
            var communityEl = document.getElementById('communityCards');
            var existingCount = communityEl.children.length;
            for (var k = existingCount; k < game.communityCards.length; k++) {
                var c = game.communityCards[k];
                var cardDiv = document.createElement('div');
                var colorClass = (c.suit === 'â™¥' || c.suit === 'â™¦') ? 'red' : 'black';
                cardDiv.className = 'card ' + colorClass;
                cardDiv.textContent = c.rank + c.suit;
                communityEl.appendChild(cardDiv);
            }
            
            // æ›´æ–°ç©å®¶
            var human = game.players[humanIndex];
            document.getElementById('playerChips').textContent = '$' + human.chips;
            
            var handKey = JSON.stringify(human.cards);
            if (handKey !== lastHandCards && human.cards.length === 2) {
                var playerCardsEl = document.getElementById('playerCards');
                playerCardsEl.innerHTML = '';
                for (var cidx = 0; cidx < human.cards.length; cidx++) {
                    var card = human.cards[cidx];
                    var cardEl = document.createElement('div');
                    cardEl.className = 'card ' + ((card.suit === 'â™¥' || card.suit === 'â™¦') ? 'red' : 'black');
                    cardEl.textContent = card.rank + card.suit;
                    playerCardsEl.appendChild(cardEl);
                }
                lastHandCards = handKey;
            }
            
            if (human.cards.length === 2) {
                var winRate = calculateWinRate(human.cards, game.communityCards);
                var handRank = evaluateHandRank(human.cards, game.communityCards);
                document.getElementById('handRank').textContent = handRank;
                document.getElementById('winRate').textContent = winRate + '%èƒœç‡';
            }
        }
        
        function nextTurn() {
            var player = game.players[game.activeIndex];
            if (player.folded || player.allIn) { nextPlayer(); return; }
            updateDisplay();
            if (player.isHuman) { showPlayerActions(); }
            else { setTimeout(function() { aiDecision(player); }, 1000); }
        }
        
        function showPlayerActions() {
            var player = game.players[0];
            var toCall = game.currentBet - player.bet;
            document.getElementById('actionButtons').style.display = 'grid';
            document.getElementById('btnCheck').style.display = toCall === 0 ? 'block' : 'none';
            document.getElementById('btnCall').style.display = toCall > 0 ? 'block' : 'none';
            document.getElementById('btnCall').textContent = 'è·Ÿæ³¨ $' + toCall;
        }
        
        function playerAction(action) {
            var player = game.players[0];
            var toCall = game.currentBet - player.bet;
            document.getElementById('actionButtons').style.display = 'none';
            
            switch(action) {
                case 'fold': player.folded = true; showToast('ä½ å¼ƒç‰Œäº†'); break;
                case 'check': showToast('ä½ è¿‡ç‰Œ'); break;
                case 'call': placeBet(player, toCall); showToast('ä½ è·Ÿæ³¨ $' + toCall); break;
                case 'raise': 
                    var raiseAmt = parseInt(prompt('åŠ æ³¨é‡‘é¢:', game.bb * 3)) || game.bb * 3;
                    placeBet(player, toCall + raiseAmt);
                    game.currentBet = player.bet;
                    game.lastRaiserIndex = game.activeIndex;  // è®°å½•åŠ æ³¨è€…
                    showToast('ä½ åŠ æ³¨åˆ° $' + player.bet);
                    break;
                case 'allin': 
                    placeBet(player, player.chips);
                    game.currentBet = Math.max(game.currentBet, player.bet);
                    game.lastRaiserIndex = game.activeIndex;  // å…¨ä¸‹ä¹Ÿè§†ä¸ºåŠ æ³¨
                    showToast('ä½ å…¨ä¸‹äº†ï¼');
                    break;
            }
            nextPlayer();
        }
        
        function aiDecision(player) {
            var type = AI_TYPES[player.type];
            var handStr = Math.random();
            var toCall = game.currentBet - player.bet;
            var action = 'fold';
            
            if (game.stage === 'preflop') {
                if (Math.random() < type.vpip && handStr > 0.3) {
                    action = (Math.random() < type.pfr || game.currentBet === player.bet) ? 'raise' : 'call';
                } else if (game.currentBet === player.bet) { action = 'check'; }
            } else {
                if (handStr > 0.6) { action = Math.random() < type.aggression / 3 ? 'raise' : 'call'; }
                else if (handStr > 0.3 && toCall < game.pot * 0.3) { action = 'call'; }
                else if (game.currentBet === player.bet) { action = 'check'; }
            }
            
            setTimeout(function() {
                switch(action) {
                    case 'fold': player.folded = true; showToast(player.name + ' å¼ƒç‰Œ'); break;
                    case 'check': showToast(player.name + ' è¿‡ç‰Œ'); break;
                    case 'call': placeBet(player, toCall); showToast(player.name + ' è·Ÿæ³¨ $' + toCall); break;
                    case 'raise': 
                        var raiseAmt = game.bb * (2 + Math.floor(Math.random() * 3));
                        placeBet(player, toCall + raiseAmt);
                        game.currentBet = player.bet;
                        game.lastRaiserIndex = game.activeIndex;  // è®°å½•åŠ æ³¨è€…
                        showToast(player.name + ' åŠ æ³¨åˆ° $' + player.bet);
                        break;
                }
                nextPlayer();
            }, 1000);
        }
        
        // è·Ÿè¸ªæ¯è½®è°å·²ç»è¡ŒåŠ¨è¿‡
        let actedPlayers = new Set();
        
        function nextPlayer() {
            var active = game.players.filter(function(p) { return !p.folded; });
            if (active.length === 1) { endHand(active[0]); return; }
            
            // è®°å½•å½“å‰ç©å®¶å·²è¡ŒåŠ¨
            actedPlayers.add(game.activeIndex);
            
            // æ‰¾åˆ°ä¸‹ä¸€ä¸ªæœªå¼ƒç‰Œä¸”æœªallinçš„ç©å®¶
            var nextIndex = game.activeIndex;
            do {
                nextIndex = (nextIndex + 1) % game.players.length;
            } while (game.players[nextIndex].folded || game.players[nextIndex].allIn);
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
            var needToAct = game.players.filter(function(p) { return !p.folded && !p.allIn; });
            var allBetsEqual = needToAct.every(function(p) { return p.bet === game.currentBet; });
            
            // æ¡ä»¶1ï¼šæ‰€æœ‰äººéƒ½ä¸‹æ³¨ç›¸ç­‰ï¼Œä¸”æ‰€æœ‰äººéƒ½è‡³å°‘è¡ŒåŠ¨è¿‡ä¸€æ¬¡
            var allActed = needToAct.every(function(p, idx) {
                var playerIdx = game.players.indexOf(p);
                return actedPlayers.has(playerIdx);
            });
            
            // æ¡ä»¶2ï¼šå›åˆ°æœ€ååŠ æ³¨è€…ä½ç½®
            var backToRaiser = (game.lastRaiserIndex !== -1 && nextIndex === game.lastRaiserIndex && allBetsEqual);
            
            // æ¡ä»¶3ï¼šæ‰€æœ‰äººéƒ½è¿‡ç‰Œï¼ˆcurrentBetä¸º0ï¼Œä¸”æ‰€æœ‰äººéƒ½è¡ŒåŠ¨è¿‡ï¼‰
            var allChecked = (game.currentBet === 0 && allActed && actedPlayers.size >= needToAct.length);
            
            if ((backToRaiser || allChecked) && allBetsEqual && needToAct.length > 0) {
                actedPlayers.clear();  // æ¸…ç©ºå·²è¡ŒåŠ¨è®°å½•
                nextStage();
                return;
            }
            
            game.activeIndex = nextIndex;
            nextTurn();
        }
        
        function nextStage() {
            // æ”¶æ‹¢æ‰€æœ‰ä¸‹æ³¨åˆ°åº•æ± 
            game.players.forEach(function(p) { p.bet = 0; });
            game.currentBet = 0;
            game.lastRaiserIndex = -1;
            actedPlayers.clear();  // æ¸…ç©ºå·²è¡ŒåŠ¨è®°å½•
            
            // å‘ç‰Œ
            if (game.stage === 'preflop') {
                game.stage = 'flop';
                game.communityCards.push(deal(), deal(), deal());
                showToast('ç¿»ç‰Œ: ' + game.communityCards.map(function(c) { return c.rank + c.suit; }).join(' '));
            } else if (game.stage === 'flop') {
                game.stage = 'turn';
                game.communityCards.push(deal());
                showToast('è½¬ç‰Œ: ' + game.communityCards[3].rank + game.communityCards[3].suit);
            } else if (game.stage === 'turn') {
                game.stage = 'river';
                game.communityCards.push(deal());
                showToast('æ²³ç‰Œ: ' + game.communityCards[4].rank + game.communityCards[4].suit);
            } else if (game.stage === 'river') {
                showdown();
                return;
            }
            
            // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœªå¼ƒç‰Œçš„ç©å®¶ï¼ˆä»åº„å®¶å·¦è¾¹å¼€å§‹ï¼‰
            var startIndex = (game.dealerIndex + 1) % game.players.length;
            while (game.players[startIndex].folded) {
                startIndex = (startIndex + 1) % game.players.length;
            }
            game.activeIndex = startIndex;
            game.lastRaiserIndex = -1;  // æ–°ä¸€è½®ï¼Œé‡ç½®åŠ æ³¨è€…
            actedPlayers.clear();  // æ¸…ç©ºå·²è¡ŒåŠ¨è®°å½•
            
            updateDisplay();
            nextTurn();
        }
        
        function showdown() {
            game.stage = 'showdown';
            updateDisplay();
            
            // æ˜¾ç¤ºAIæ‰‹ç‰Œ
            var active = game.players.filter(function(p) { return !p.folded; });
            active.forEach(function(p) {
                if (!p.isHuman) {
                    var seats = document.querySelectorAll('.opponent-seat');
                    for (var i = 0; i < seats.length; i++) {
                        var nameEl = seats[i].querySelector('.opponent-name');
                        if (nameEl && nameEl.textContent === p.name) {
                            var cardsDiv = document.createElement('div');
                            cardsDiv.className = 'opponent-cards';
                            for (var c = 0; c < p.cards.length; c++) {
                                var card = p.cards[c];
                                var cardEl = document.createElement('div');
                                cardEl.className = 'card ' + ((card.suit === 'â™¥' || card.suit === 'â™¦') ? 'red' : 'black');
                                cardEl.textContent = card.rank + card.suit;
                                cardsDiv.appendChild(cardEl);
                            }
                            seats[i].appendChild(cardsDiv);
                        }
                    }
                }
            });
            
            // è®¡ç®—èµ¢å®¶
            var winner = active[0];
            var bestStrength = -1;
            active.forEach(function(p) {
                var strength = evaluateHandStrength(p.cards, game.communityCards);
                if (strength > bestStrength) { bestStrength = strength; winner = p; }
            });
            
            setTimeout(function() {
                winner.chips += game.pot;
                showToast('ğŸ† ' + winner.name + ' èµ¢å¾— $' + game.pot + '!');
                
                var seats = document.querySelectorAll('.opponent-seat');
                for (var s = 0; s < seats.length; s++) {
                    var nameEl = seats[s].querySelector('.opponent-name');
                    if (nameEl && nameEl.textContent === winner.name) {
                        seats[s].classList.add('winner');
                    }
                }
                
                setTimeout(function() {
                    game.dealerIndex = (game.dealerIndex + 1) % game.players.length;
                    newHand();
                }, 4000);
            }, 1500);
        }
        
        function evaluateHandStrength(hole, community) {
            var all = hole.concat(community);
            if (all.length < 2) return 0;
            var ranks = all.map(function(c) { return c.value; });
            var suits = all.map(function(c) { return c.suit; });
            
            var rankCounts = {};
            ranks.forEach(function(r) { rankCounts[r] = (rankCounts[r] || 0) + 1; });
            var counts = Object.values(rankCounts).sort(function(a, b) { return b - a; });
            
            var suitCounts = {};
            suits.forEach(function(s) { suitCounts[s] = (suitCounts[s] || 0) + 1; });
            var hasFlush = false;
            for (var sk in suitCounts) { if (suitCounts[sk] >= 5) hasFlush = true; }
            
            var uniqueRanks = [];
            for (var uk in rankCounts) uniqueRanks.push(parseInt(uk));
            uniqueRanks.sort(function(a, b) { return a - b; });
            var hasStraight = false;
            for (var i = 0; i <= uniqueRanks.length - 5; i++) {
                if (uniqueRanks[i+4] - uniqueRanks[i] === 4) hasStraight = true;
            }
            
            var strength = 0;
            if (hasStraight && hasFlush) strength = 8000000;
            else if (counts[0] === 4) strength = 7000000;
            else if (counts[0] === 3 && counts[1] >= 2) strength = 6000000;
            else if (hasFlush) strength = 5000000;
            else if (hasStraight) strength = 4000000;
            else if (counts[0] === 3) strength = 3000000;
            else if (counts[0] === 2 && counts[1] === 2) strength = 2000000;
            else if (counts[0] === 2) strength = 1000000;
            else strength = Math.max.apply(null, ranks);
            
            return strength;
        }
        
        function endHand(winner) {
            winner.chips += game.pot;
            showToast('ğŸ† ' + winner.name + ' èµ¢å¾— $' + game.pot + '!');
            updateDisplay();
            setTimeout(function() {
                game.dealerIndex = (game.dealerIndex + 1) % game.players.length;
                newHand();
            }, 3000);
        }
        
        function showToast(msg) {
            var toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.style.display = 'block';
            setTimeout(function() { toast.style.display = 'none'; }, 2000);
        }
    </script>
</body>
</html>
